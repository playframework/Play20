#! /usr/bin/env sh

PRG="$0"
while [ -h "$PRG" ] ; do
    PRG=`readlink "$PRG"`
done

dir=`dirname $PRG`

if [ `uname -o` == "Cygwin" ]
then
  SBT_IVY_HOME=$(cygpath -w -a $dir/repository)
  PLAY_HOME=$(cygpath -w -a $dir/framework)
  SBT_LAUNCH_JAR=$(cygpath -w -a $dir/framework/sbt/sbt-launch.jar)
  SBT_BOOT_PROPS=file:///$(cygpath -m -a $dir/framework/sbt/sbt.boot.properties)
  JLINE_TERMINAL=-Djline.terminal=jline.UnixTerminal
  BUILD=$(cygpath -m -a $dir/framework/build)
else 
  SBT_IVY_HOME=$dir/repository
  PLAY_HOME=$dir/framework
  SBT_LAUNCH_JAR=$PLAY_HOME/sbt/sbt-launch.jar
  SBT_BOOT_PROPS=$PLAY_HOME/sbt/sbt.boot.properties
  BUILD=$dir/framework/build
fi

JAVA_ARGS="$JLINE_TERMINAL -Dsbt.ivy.home=$SBT_IVY_HOME -Dplay.home=$PLAY_HOME -Dsbt.boot.properties=$SBT_BOOT_PROPS"

if [ -f conf/application.conf ]; then
  if test "$1" = "clean-all"; then
    rm -rf target
    rm -rf tmp
    rm -rf logs
    rm -rf dist
    rm -rf project/project
    rm -rf project/target
    if [ $# -ne 1 ]
    then  
     shift
    else
      echo "[info] Done!"
      exit 0
    fi
  fi
  if test "$1" = "stop"; then
    if [ -f RUNNING_PID ]; then
      echo "[info] Stopping application (with PID `cat RUNNING_PID`)..."
      kill `cat RUNNING_PID`

      RESULT=$?

      if test "$RESULT" = 0; then
        echo "[info] Done!"
        exit 0
      else
        echo "[\033[31merror\033[0m] Failed ($RESULT)"
        exit $RESULT
      fi
    else
      echo "[\033[31merror\033[0m] No RUNNING_PID file. Is this application running?"
      exit 1
    fi
  fi
  
  if test "$1" = "debug"; then
    JPDA_PORT="9999"
    shift      
  fi

  if [ -n "$1" ]; then
    JPDA_PORT="${JPDA_PORT}" $BUILD "$@"
  else
    JPDA_PORT="${JPDA_PORT}" $BUILD play
  fi
  
else
  java ${DEBUG_PARAM} ${JAVA_ARGS} -jar $SBT_LAUNCH_JAR "$@"
fi